<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Processor SocketIO Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>File Processor SocketIO Integration Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="connection-status" class="alert alert-info">Initializing...</div>
                        <div id="connection-details"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Progress</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-progress"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>File Processor Simulation</h5>
                    </div>
                    <div class="card-body">
                        <button id="test-file-processor" class="btn btn-primary">Test File Processor SocketIO</button>
                        <button id="test-enhanced-wait" class="btn btn-secondary ms-2">Test Enhanced Wait Function</button>
                        <div id="processor-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Starting File Processor SocketIO Test');
        
        // Initialize SocketIO with enhanced configuration
        window.socket = io({
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        
        let connectionEstablished = false;
        let connectionStartTime = Date.now();
        
        function updateConnectionStatus(status, message, type = 'info') {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'}`;
            statusDiv.innerHTML = `<strong>${status}:</strong> ${message}`;
            
            const detailsDiv = document.getElementById('connection-details');
            detailsDiv.innerHTML = `
                <small class="text-muted">
                    Last update: ${new Date().toLocaleTimeString()}<br>
                    Socket ID: ${window.socket?.id || 'Not connected'}<br>
                    Connected: ${window.socket?.connected ? 'Yes' : 'No'}
                </small>
            `;
        }
        
        function addTestProgress(message, success = true) {
            const progressDiv = document.getElementById('test-progress');
            const alertClass = success ? 'alert-success' : 'alert-danger';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            progressDiv.innerHTML += `
                <div class="${alertClass} alert py-2 mb-2">
                    ${icon} ${message}
                </div>
            `;
        }
        
        // Simulate the waitForSocketConnection function from fileProcessor.js
        async function waitForSocketConnection(timeout = 30000) {
            console.log('üîó Starting enhanced waitForSocketConnection...');
            
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                let attempts = 0;
                const maxAttempts = 10;
                
                function checkConnection() {
                    attempts++;
                    const elapsed = Date.now() - startTime;
                    
                    console.log(`Attempt ${attempts}: Checking SocketIO connection...`);
                    addTestProgress(`Connection attempt ${attempts} (${elapsed}ms elapsed)`);
                    
                    if (window.socket && window.socket.connected) {
                        console.log('‚úÖ SocketIO connection established!');
                        addTestProgress('SocketIO connection established!', true);
                        resolve(true);
                        return;
                    }
                    
                    if (elapsed >= timeout) {
                        console.error('‚ùå SocketIO connection timeout');
                        addTestProgress(`Connection timeout after ${timeout}ms`, false);
                        reject(new Error('SocketIO connection timeout'));
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.error('‚ùå Maximum connection attempts reached');
                        addTestProgress(`Maximum attempts (${maxAttempts}) reached`, false);
                        reject(new Error('Maximum connection attempts reached'));
                        return;
                    }
                    
                    // Try manual connection if socket exists but isn't connected
                    if (window.socket && !window.socket.connected) {
                        console.log('üîÑ Attempting manual reconnection...');
                        try {
                            window.socket.connect();
                        } catch (error) {
                            console.warn('Manual reconnection failed:', error);
                        }
                    }
                    
                    // Wait and retry
                    setTimeout(checkConnection, Math.min(1000 * attempts, 3000));
                }
                
                checkConnection();
            });
        }
        
        // Simulate the initializeSocketIO function from fileProcessor.js
        async function initializeSocketIO() {
            console.log('üöÄ Starting enhanced SocketIO initialization...');
            addTestProgress('Starting SocketIO initialization...');
            
            try {
                // Check if SocketIO is available
                if (typeof io === 'undefined') {
                    throw new Error('Socket.IO not available');
                }
                
                addTestProgress('Socket.IO library detected');
                
                // Wait for connection
                await waitForSocketConnection(15000);
                
                addTestProgress('SocketIO initialization completed successfully!', true);
                return true;
                
            } catch (error) {
                console.error('‚ùå SocketIO initialization failed:', error);
                addTestProgress(`SocketIO initialization failed: ${error.message}`, false);
                return false;
            }
        }
        
        // Socket event handlers
        window.socket.on('connect', () => {
            connectionEstablished = true;
            const connectionTime = Date.now() - connectionStartTime;
            
            console.log(`‚úÖ Connected to server: ${window.socket.id}`);
            updateConnectionStatus('Connected', `Connected to server in ${connectionTime}ms`, 'success');
            addTestProgress(`Connected with ID: ${window.socket.id}`, true);
        });
        
        window.socket.on('connect_error', (error) => {
            console.error('‚ùå Connection error:', error);
            updateConnectionStatus('Connection Error', error.message, 'error');
            addTestProgress(`Connection error: ${error.message}`, false);
        });
        
        window.socket.on('disconnect', (reason) => {
            connectionEstablished = false;
            console.warn('‚ö†Ô∏è Disconnected:', reason);
            updateConnectionStatus('Disconnected', reason, 'warning');
            addTestProgress(`Disconnected: ${reason}`, false);
        });
        
        window.socket.on('reconnect', (attemptNumber) => {
            console.log(`üîÑ Reconnected after ${attemptNumber} attempts`);
            updateConnectionStatus('Reconnected', `Reconnected after ${attemptNumber} attempts`, 'success');
            addTestProgress(`Reconnected after ${attemptNumber} attempts`, true);
        });
        
        // Test buttons
        document.getElementById('test-file-processor').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('processor-results');
            resultsDiv.innerHTML = '<div class="alert alert-info">Testing File Processor SocketIO integration...</div>';
            
            try {
                console.log('üß™ Testing File Processor SocketIO integration...');
                
                // Simulate the file processor initialization
                const success = await initializeSocketIO();
                
                if (success) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>‚úÖ File Processor SocketIO Test Passed!</h6>
                            <p>The enhanced SocketIO initialization successfully resolved the "Waiting for SocketIO connection..." issue.</p>
                            <ul>
                                <li>Connection established: ${window.socket?.connected ? 'Yes' : 'No'}</li>
                                <li>Socket ID: ${window.socket?.id || 'None'}</li>
                                <li>Ready for task processing: ${window.socket?.connected ? 'Yes' : 'No'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>‚ùå File Processor SocketIO Test Failed!</h6>
                            <p>The SocketIO initialization failed. The "Waiting for SocketIO connection..." issue persists.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Test Error</h6>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        });
        
        document.getElementById('test-enhanced-wait').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('processor-results');
            resultsDiv.innerHTML = '<div class="alert alert-info">Testing enhanced waitForSocketConnection function...</div>';
            
            try {
                const startTime = Date.now();
                await waitForSocketConnection(10000);
                const duration = Date.now() - startTime;
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6>‚úÖ Enhanced Wait Function Test Passed!</h6>
                        <p>Successfully waited for SocketIO connection in ${duration}ms</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Enhanced Wait Function Test Failed!</h6>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        });
        
        // Initial status
        updateConnectionStatus('Connecting', 'Attempting to connect to server...', 'info');
        
        // Auto-test after 3 seconds
        setTimeout(() => {
            if (connectionEstablished) {
                document.getElementById('test-file-processor').click();
            }
        }, 3000);
    </script>
</body>
</html>