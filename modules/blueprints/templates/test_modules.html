<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroGen Module System Diagnostics</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .main-header {
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #4a9eff;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(74, 158, 255, 0.3);
        }
        
        .diagnostic-card {
            background: rgba(45, 45, 68, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .diagnostic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(74, 158, 255, 0.4);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-healthy {
            background: rgba(40, 167, 69, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .status-critical {
            background: rgba(220, 53, 69, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .module-item {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }
        
        .module-item:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
        }
        
        .module-exists {
            color: #4ade80;
        }
        
        .module-missing {
            color: #f87171;
        }
        
        .issue-item {
            background: rgba(248, 113, 113, 0.1);
            border-left: 4px solid #f87171;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .recommendation-item {
            background: rgba(251, 191, 36, 0.1);
            border-left: 4px solid #fbbf24;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .endpoint-status {
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .endpoint-exists {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .endpoint-missing {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 600;
            color: #4a9eff;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-top: 5px;
        }
        
        .action-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .btn-float {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.5);
        }
        
        pre {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-stethoscope text-info me-3"></i>
                        Module System Diagnostics
                    </h1>
                    <p class="text-muted mb-0 mt-2">
                        Real-time health monitoring for NeuroGen ES6 modules
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="status-indicator" class="d-inline-block">
                        <!-- Status will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mb-5">
        <!-- Loading State -->
        <div id="loading-state" class="loading-spinner">
            <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status">
                <span class="visually-hidden">Running diagnostics...</span>
            </div>
            <h4 class="mt-4 pulse">Running System Diagnostics...</h4>
            <p class="text-muted">Analyzing modules, endpoints, and system health</p>
        </div>

        <!-- Diagnostics Content -->
        <div id="diagnostics-content" style="display: none;">
            <!-- Quick Stats -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-number" id="stat-modules">-</div>
                    <div class="stat-label">Modules Loaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-issues">-</div>
                    <div class="stat-label">Issues Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-endpoints">-</div>
                    <div class="stat-label">API Endpoints</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-health">-</div>
                    <div class="stat-label">System Health</div>
                </div>
            </div>

            <!-- Issues Section -->
            <div id="issues-section" class="diagnostic-card" style="display: none;">
                <h3 class="mb-3">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Issues Detected
                </h3>
                <div id="issues-list"></div>
            </div>

            <!-- Recommendations Section -->
            <div id="recommendations-section" class="diagnostic-card" style="display: none;">
                <h3 class="mb-3">
                    <i class="fas fa-lightbulb text-info me-2"></i>
                    Recommendations
                </h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- Module Status -->
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="diagnostic-card">
                        <h4 class="mb-3">
                            <i class="fas fa-cube text-primary me-2"></i>
                            Core Modules
                        </h4>
                        <div id="core-modules" class="module-grid"></div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="diagnostic-card">
                        <h4 class="mb-3">
                            <i class="fas fa-tools text-success me-2"></i>
                            Utility Modules
                        </h4>
                        <div id="utils-modules" class="module-grid"></div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="diagnostic-card">
                        <h4 class="mb-3">
                            <i class="fas fa-puzzle-piece text-warning me-2"></i>
                            Feature Modules
                        </h4>
                        <div id="features-modules" class="module-grid"></div>
                    </div>
                </div>
            </div>

            <!-- API Endpoints -->
            <div class="diagnostic-card">
                <h3 class="mb-3">
                    <i class="fas fa-plug text-info me-2"></i>
                    API Endpoints
                </h3>
                <div class="row" id="endpoints-container"></div>
            </div>

            <!-- Module Loading Info -->
            <div class="diagnostic-card">
                <h3 class="mb-3">
                    <i class="fas fa-info-circle text-secondary me-2"></i>
                    System Information
                </h3>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Loading Configuration</h5>
                        <ul class="list-unstyled">
                            <li><strong>Entry Point:</strong> <span id="entry-point"></span></li>
                            <li><strong>Module System:</strong> <span id="module-system"></span></li>
                            <li><strong>Timeout:</strong> <span id="module-timeout"></span></li>
                            <li><strong>Python Version:</strong> <span id="python-version"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Server Information</h5>
                        <ul class="list-unstyled">
                            <li><strong>Port:</strong> <span id="server-port"></span></li>
                            <li><strong>Version:</strong> <span id="server-version"></span></li>
                            <li><strong>Timestamp:</strong> <span id="timestamp"></span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Raw Data -->
            <div class="diagnostic-card">
                <h3 class="mb-3">
                    <i class="fas fa-code text-muted me-2"></i>
                    Raw Diagnostic Data
                    <button class="btn btn-sm btn-outline-secondary float-end" onclick="toggleRawData()">
                        <i class="fas fa-eye"></i> Toggle
                    </button>
                </h3>
                <pre id="raw-data" style="display: none;"></pre>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-primary btn-float" onclick="runDiagnostics()" title="Refresh Diagnostics">
            <i class="fas fa-sync"></i>
        </button>
        <button class="btn btn-success btn-float" onclick="downloadReport()" title="Download Report">
            <i class="fas fa-download"></i>
        </button>
        <a href="/" class="btn btn-secondary btn-float" title="Back to App">
            <i class="fas fa-home"></i>
        </a>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let diagnosticsData = null;

        // Run diagnostics on page load
        window.addEventListener('DOMContentLoaded', () => {
            runDiagnostics();
            
            // Auto-refresh every 30 seconds
            setInterval(runDiagnostics, 30000);
        });

        async function runDiagnostics() {
            document.getElementById('loading-state').style.display = 'flex';
            document.getElementById('diagnostics-content').style.display = 'none';

            try {
                const response = await fetch('/test-modules?format=json', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                diagnosticsData = await response.json();
                displayDiagnostics(diagnosticsData);
            } catch (error) {
                console.error('Failed to fetch diagnostics:', error);
                showError('Failed to fetch diagnostics. Please check the console for details.');
            }
        }

        function displayDiagnostics(data) {
            // Update status indicator
            const statusIndicator = document.getElementById('status-indicator');
            const healthClass = data.summary.health.toLowerCase();
            statusIndicator.innerHTML = `
                <span class="status-badge status-${healthClass}">
                    <i class="fas fa-circle"></i>
                    ${data.summary.health}
                </span>
            `;

            // Update stats
            document.getElementById('stat-modules').textContent = 
                `${data.summary.foundModules}/${data.summary.totalExpectedModules}`;
            document.getElementById('stat-issues').textContent = data.summary.issueCount;
            
            // Count total endpoints
            let totalEndpoints = 0;
            let workingEndpoints = 0;
            Object.values(data.endpoints).forEach(feature => {
                Object.values(feature).forEach(endpoint => {
                    totalEndpoints++;
                    if (endpoint.exists) workingEndpoints++;
                });
            });
            document.getElementById('stat-endpoints').textContent = `${workingEndpoints}/${totalEndpoints}`;
            document.getElementById('stat-health').textContent = 
                data.summary.health === 'HEALTHY' ? '100%' : 
                (data.summary.health === 'WARNING' ? '75%' : '25%');

            // Display issues
            if (data.issues.length > 0) {
                document.getElementById('issues-section').style.display = 'block';
                const issuesList = document.getElementById('issues-list');
                issuesList.innerHTML = data.issues.map(issue => `
                    <div class="issue-item">
                        <h6 class="mb-1">
                            <span class="badge bg-danger">${issue.type}</span>
                        </h6>
                        <p class="mb-0">${issue.module || issue.file || issue.endpoint}: ${issue.message}</p>
                    </div>
                `).join('');
            } else {
                document.getElementById('issues-section').style.display = 'none';
            }

            // Display recommendations
            if (data.recommendations.length > 0) {
                document.getElementById('recommendations-section').style.display = 'block';
                const recList = document.getElementById('recommendations-list');
                recList.innerHTML = data.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <h6 class="mb-1">
                            <span class="badge bg-${rec.priority === 'HIGH' ? 'danger' : 'warning'}">${rec.priority}</span>
                            ${rec.message}
                        </h6>
                        <p class="mb-0 text-muted">${rec.action}</p>
                    </div>
                `).join('');
            } else {
                document.getElementById('recommendations-section').style.display = 'none';
            }

            // Display modules
            displayModules('core', data.modules.core);
            displayModules('utils', data.modules.utils);
            displayModules('features', data.modules.features);

            // Display endpoints
            displayEndpoints(data.endpoints);

            // Display system info
            document.getElementById('entry-point').textContent = data.moduleLoadingInfo.entryPoint;
            document.getElementById('module-system').textContent = data.moduleLoadingInfo.moduleSystem;
            document.getElementById('module-timeout').textContent = data.moduleLoadingInfo.timeout;
            document.getElementById('python-version').textContent = data.server.pythonVersion.split(' ')[0];
            document.getElementById('server-port').textContent = data.server.port;
            document.getElementById('server-version').textContent = data.server.version;
            document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString();

            // Raw data
            document.getElementById('raw-data').textContent = JSON.stringify(data, null, 2);

            // Show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('diagnostics-content').style.display = 'block';
        }

        function displayModules(category, modules) {
            const container = document.getElementById(`${category}-modules`);
            container.innerHTML = Object.entries(modules).map(([name, info]) => {
                const icon = info.exists ? 'check-circle' : 'times-circle';
                const colorClass = info.exists ? 'module-exists' : 'module-missing';
                const size = info.exists ? `${(info.size / 1024).toFixed(1)}KB` : 'N/A';
                
                return `
                    <div class="module-item" title="${info.path}">
                        <span class="${colorClass}">
                            <i class="fas fa-${icon} me-2"></i>
                            ${name}
                        </span>
                        <small class="text-muted">${size}</small>
                    </div>
                `;
            }).join('');
        }

        function displayEndpoints(endpoints) {
            const container = document.getElementById('endpoints-container');
            container.innerHTML = Object.entries(endpoints).map(([feature, eps]) => `
                <div class="col-md-6 mb-3">
                    <h5 class="text-info">${feature}</h5>
                    ${Object.entries(eps).map(([name, info]) => {
                        const statusClass = info.exists ? 'endpoint-exists' : 'endpoint-missing';
                        const icon = info.exists ? 'check' : 'times';
                        const iconColor = info.exists ? 'text-success' : 'text-danger';
                        
                        return `
                            <div class="endpoint-status ${statusClass}">
                                <span>
                                    <i class="fas fa-${icon} ${iconColor} me-2"></i>
                                    <strong>${name}:</strong> ${info.url}
                                </span>
                                <small class="text-muted">${info.methods.join(', ')}</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function toggleRawData() {
            const rawData = document.getElementById('raw-data');
            rawData.style.display = rawData.style.display === 'none' ? 'block' : 'none';
        }

        function downloadReport() {
            if (!diagnosticsData) return;
            
            const report = {
                ...diagnosticsData,
                generatedAt: new Date().toISOString(),
                reportType: 'NeuroGen Module Diagnostics Report'
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `neurogen-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                </div>
                <button class="btn btn-primary mt-3" onclick="runDiagnostics()">
                    <i class="fas fa-sync me-2"></i>Try Again
                </button>
            `;
        }
    </script>
</body>
</html>