<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completion Transition Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Completion Transition Fix Test</h2>
        <p class="text-muted">Testing FileProcessor completion transition using correct module path: <code>window.fileProcessor</code></p>
        
        <!-- Test Controls -->
        <div class="card mb-4">
            <div class=\"card-body\">
                <h5>Test Controls</h5>
                <button id="test-window-fileprocessor" class="btn btn-primary me-2">Test window.fileProcessor.testCompletionTransition()</button>
                <button id="test-availability" class="btn btn-info me-2">Check Module Availability</button>
                <button id="clear-console" class="btn btn-secondary">Clear Console</button>
            </div>
        </div>

        <!-- File Processing Structure (matching main interface) -->
        <div class="tab-content">
            <div class="tab-pane fade show active">
                <!-- Progress Container -->
                <div id="progress-container" class="transition-container">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-cogs me-2"></i>Processing Files - Ready for Completion Test
                            </h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar bg-success progress-bar-striped" 
                                     role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                    100%
                                </div>
                            </div>
                            <div id="progress-status" class="mb-2">Processing completed - ready to test completion transition...</div>
                            <div id="progress-stats" class="small text-muted">Click the test button above to trigger the completion transition.</div>
                        </div>
                    </div>
                </div>
                        
                <!-- Result Container -->
                <div id="result-container" class="transition-container d-none">
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <span>Processing Completed Successfully!</span>
                    </div>
                    <div id="result-stats" class="mb-3 small"></div>
                    <div class="d-flex gap-2 mb-3">
                        <button id="open-btn" class="btn btn-success open-json-btn">
                            <i class="fas fa-folder-open me-2"></i> Open JSON
                        </button>
                        <button id="new-task-btn" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i> New Task
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="card mt-4">
            <div class="card-body">
                <h6>Debug Console</h6>
                <div id="debug-console" style="height: 400px; overflow-y: auto; background: #1e1e1e; color: #d4edda; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; border-radius: 5px;">
                    Completion transition test ready...<br>
                    Waiting for user to click test button...<br>
                </div>
            </div>
        </div>
    </div>

    <!-- Load SocketIO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Load necessary modules -->
    <script type="module">
        // Module loading and testing
        import { ENDPOINTS } from '/static/js/modules/config/endpoints.js';
        import { CONSTANTS } from '/static/js/modules/config/constants.js';
        
        // Debug console setup
        function logDebug(message, type = 'info') {
            const debugConsole = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            let prefix = 'üîç';
            let color = '#d4edda';
            
            switch(type) {
                case 'success': prefix = '‚úÖ'; color = '#28a745'; break;
                case 'error': prefix = '‚ùå'; color = '#dc3545'; break;
                case 'warning': prefix = '‚ö†Ô∏è'; color = '#ffc107'; break;
                case 'test': prefix = 'üß™'; color = '#17a2b8'; break;
            }
            
            debugConsole.innerHTML += `<span style="color: ${color}">${timestamp} ${prefix} ${message}</span><br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('debug-console').innerHTML = 'Console cleared...<br>';
        }

        // Test window.fileProcessor availability
        function testModuleAvailability() {
            logDebug('Checking module availability...', 'test');
            
            // Check window.fileProcessor (discovered path)
            if (window.fileProcessor) {
                logDebug('‚úÖ window.fileProcessor is available!', 'success');
                logDebug('Available methods: ' + Object.getOwnPropertyNames(window.fileProcessor).join(', '));
                
                if (window.fileProcessor.testCompletionTransition) {
                    logDebug('‚úÖ testCompletionTransition method found!', 'success');
                } else {
                    logDebug('‚ùå testCompletionTransition method NOT found', 'error');
                }
                
                if (window.fileProcessor.handleTaskCompleted) {
                    logDebug('‚úÖ handleTaskCompleted method found!', 'success');
                } else {
                    logDebug('‚ùå handleTaskCompleted method NOT found', 'error');
                }
            } else {
                logDebug('‚ùå window.fileProcessor is NOT available', 'error');
            }
            
            // Check window.NeuroGen path (alternative)
            if (window.NeuroGen && window.NeuroGen.modules && window.NeuroGen.modules.fileProcessor) {
                logDebug('‚úÖ window.NeuroGen.modules.fileProcessor is also available!', 'success');
            } else {
                logDebug('‚ö†Ô∏è window.NeuroGen.modules.fileProcessor is NOT available', 'warning');
            }
            
            // List all available on window
            const windowKeys = Object.keys(window).filter(key => 
                key.includes('file') || key.includes('File') || key.includes('NeuroGen') || key.includes('MODULE')
            );
            logDebug('Relevant window keys: ' + windowKeys.join(', '));
        }

        // Test completion transition using window.fileProcessor
        function testWindowFileProcessor() {
            logDebug('Testing window.fileProcessor.testCompletionTransition()...', 'test');
            
            if (window.fileProcessor && window.fileProcessor.testCompletionTransition) {
                try {
                    // Mock completion data
                    const mockData = {
                        task_id: 'test_fix_completion_123',
                        task_type: 'file_processing',
                        status: 'completed',
                        progress: 100,
                        message: 'File Processing completed successfully',
                        output_file: '/workspace/modules/downloads/test_output.json',
                        stats: {
                            total_files: 5,
                            processed_files: 5,
                            error_files: 0,
                            skipped_files: 0,
                            formatted_duration: '1.8s',
                            formatted_total_size: '42.3 KB',
                            success_rate_percent: 100
                        }
                    };
                    
                    logDebug('Mock data prepared: ' + JSON.stringify(mockData.stats), 'info');
                    logDebug('Calling window.fileProcessor.testCompletionTransition()...', 'test');
                    
                    // Call the test method
                    const result = window.fileProcessor.testCompletionTransition(mockData);
                    
                    logDebug('‚úÖ testCompletionTransition called successfully!', 'success');
                    logDebug('Result: ' + JSON.stringify(result), 'info');
                    
                    // Check if containers transitioned
                    setTimeout(() => {
                        const progressContainer = document.getElementById('progress-container');
                        const resultContainer = document.getElementById('result-container');
                        
                        if (progressContainer && progressContainer.classList.contains('d-none')) {
                            logDebug('‚úÖ Progress container hidden successfully!', 'success');
                        } else {
                            logDebug('‚ö†Ô∏è Progress container still visible', 'warning');
                        }
                        
                        if (resultContainer && !resultContainer.classList.contains('d-none')) {
                            logDebug('‚úÖ Result container shown successfully!', 'success');
                        } else {
                            logDebug('‚ö†Ô∏è Result container still hidden', 'warning');
                        }
                        
                        const resultStats = document.getElementById('result-stats');
                        if (resultStats && resultStats.innerHTML.includes('Files')) {
                            logDebug('‚úÖ Result stats populated successfully!', 'success');
                        } else {
                            logDebug('‚ö†Ô∏è Result stats not populated', 'warning');
                        }
                    }, 200);
                    
                } catch (error) {
                    logDebug('‚ùå Error calling testCompletionTransition: ' + error.message, 'error');
                    logDebug('Error stack: ' + error.stack, 'error');
                }
            } else {
                logDebug('‚ùå window.fileProcessor.testCompletionTransition is not available', 'error');
                testModuleAvailability(); // Run availability check to see what we have
            }
        }

        // Event listeners
        document.getElementById('test-window-fileprocessor').addEventListener('click', testWindowFileProcessor);
        document.getElementById('test-availability').addEventListener('click', testModuleAvailability);
        document.getElementById('clear-console').addEventListener('click', clearConsole);

        // Initialize Socket.IO for module loading
        window.socket = io();
        
        window.socket.on('connect', function() {
            logDebug('Socket.IO connected successfully', 'success');
        });

        // Wait for modules to load, then auto-test availability
        setTimeout(() => {
            logDebug('Auto-checking module availability in 3 seconds...', 'info');
            setTimeout(() => {
                testModuleAvailability();
            }, 3000);
        }, 1000);
    </script>
</body>
</html>