<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Submit ‚Üí Progress ‚Üí Stats Flow Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .container-transition {
            transition: all 0.3s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-container {
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 2rem;
        }
        .result-container {
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
        }
        .test-log {
            background: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-cogs me-2"></i>Enhanced Submit ‚Üí Progress ‚Üí Stats Flow Test
        </h1>
        
        <!-- Test Controls -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-play-circle me-2"></i>Test Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button id="test-complete-flow" class="btn btn-primary mb-2">
                            <i class="fas fa-rocket me-2"></i>Test Complete Flow
                        </button>
                        <button id="test-container-transitions" class="btn btn-secondary mb-2">
                            <i class="fas fa-exchange-alt me-2"></i>Test Container Transitions
                        </button>
                        <button id="test-stats-display" class="btn btn-info mb-2">
                            <i class="fas fa-chart-bar me-2"></i>Test Stats Display
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="reset-test" class="btn btn-outline-secondary mb-2">
                            <i class="fas fa-undo me-2"></i>Reset Test
                        </button>
                        <button id="clear-log" class="btn btn-outline-warning mb-2">
                            <i class="fas fa-trash me-2"></i>Clear Log
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main File Processor Interface -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-file-alt me-2"></i>File Processor Interface</h5>
            </div>
            <div class="card-body">
                
                <!-- Form Container -->
                <div id="form-container" class="container-transition">
                    <form id="process-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="input-dir" class="form-label">Input Directory</label>
                                    <input type="text" class="form-control" id="input-dir" 
                                           value="/workspace/modules/downloads" 
                                           placeholder="Enter directory path">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="output-file" class="form-label">Output File</label>
                                    <input type="text" class="form-control" id="output-file" 
                                           value="enhanced_flow_test.json" 
                                           placeholder="Enter output filename">
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Start Processing
                        </button>
                        <button type="button" id="cancel-btn" class="btn btn-danger ms-2" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Cancel
                        </button>
                    </form>
                </div>

                <!-- Progress Container -->
                <div id="progress-container" class="progress-container d-none container-transition">
                    <h5><i class="fas fa-spinner fa-spin me-2"></i>Processing Files...</h5>
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    <p id="progress-status" class="mb-3">Initializing...</p>
                    <div id="progress-stats" class="small text-muted" style="display: none;"></div>
                </div>

                <!-- Result Container -->
                <div id="result-container" class="result-container d-none container-transition">
                    <!-- Results will be populated by JavaScript -->
                </div>
                
            </div>
        </div>

        <!-- Test Log -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-terminal me-2"></i>Test Log</h5>
            </div>
            <div class="card-body p-0">
                <div id="test-log" class="test-log p-3"></div>
            </div>
        </div>
    </div>

    <!-- Mock Socket.IO for testing -->
    <script>
        // Mock socket for testing
        window.socket = {
            connected: true,
            on: function(event, callback) {
                console.log(`Socket listening for: ${event}`);
                // Store callbacks for later simulation
                this.callbacks = this.callbacks || {};
                this.callbacks[event] = callback;
            },
            off: function(event, callback) {
                console.log(`Socket stopped listening for: ${event}`);
            },
            emit: function(event, data) {
                console.log(`Socket emitting: ${event}`, data);
            },
            callbacks: {}
        };
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mock Configuration -->
    <script type="module">
        // Mock configurations for testing
        window.API_ENDPOINTS = {
            FILE_PROCESSING: {
                PROCESS: '/api/process',
                HEALTH: '/api/health',
                CANCEL: '/api/cancel/:taskId'
            }
        };
        
        window.BLUEPRINT_ROUTES = {
            file_processor: '/api'
        };
        
        window.CONSTANTS = {
            MAX_FILENAME_LENGTH: 255,
            WINDOWS_INVALID_CHARS: /[<>:"|?*]/,
            WINDOWS_RESERVED_NAMES: ['CON', 'PRN', 'AUX', 'NUL']
        };
        
        window.TASK_EVENTS = {
            STARTED: 'task_started',
            PROGRESS: 'progress_update', 
            COMPLETED: 'task_completed',
            ERROR: 'task_error'
        };

        // Import and initialize FileProcessor
        import('./static/js/modules/features/fileProcessor.js').then(module => {
            const fileProcessor = module.default;
            
            // Enhanced test functions
            window.testCompleteFlow = async function() {
                log('üöÄ Starting Complete Flow Test...');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                try {
                    // Step 1: Show form (initial state)
                    log('üìã Step 1: Showing form container');
                    fileProcessor.showForm();
                    await sleep(1000);
                    
                    // Step 2: Simulate submit button click
                    log('üéØ Step 2: Simulating submit button click');
                    log('   ‚Üí Form should transition to progress container');
                    
                    // Manually trigger the transition to progress
                    fileProcessor.showProgressContainer();
                    fileProcessor.showProgress(0, 'Initializing file processing...');
                    await sleep(1500);
                    
                    // Step 3: Simulate progress updates
                    log('üìä Step 3: Simulating progress updates');
                    const progressSteps = [
                        { progress: 10, message: 'Scanning directory...' },
                        { progress: 25, message: 'Processing file 1 of 4...' },
                        { progress: 50, message: 'Processing file 2 of 4...' },
                        { progress: 75, message: 'Processing file 3 of 4...' },
                        { progress: 90, message: 'Processing file 4 of 4...' },
                        { progress: 100, message: 'Processing completed!' }
                    ];
                    
                    for (const step of progressSteps) {
                        fileProcessor.showProgress(step.progress, step.message);
                        log(`   ‚Üí Progress: ${step.progress}% - ${step.message}`);
                        await sleep(800);
                    }
                    
                    // Step 4: Transition to results with comprehensive stats
                    log('‚úÖ Step 4: Transitioning to results with comprehensive stats');
                    log('   ‚Üí Progress container should transition to results container');
                    
                    const mockStatsData = {
                        stats: {
                            total_files: 4,
                            processed_files: 4,
                            skipped_files: 0,
                            error_files: 0,
                            total_bytes: 15432,
                            total_chunks: 12,
                            total_duration_seconds: 3.45,
                            avg_file_processing_time: 0.86,
                            pdf_files: 1,
                            tables_extracted: 2,
                            references_extracted: 5
                        },
                        output_file: 'enhanced_flow_test.json'
                    };
                    
                    fileProcessor.showResultContainer(mockStatsData);
                    
                    log('üéâ Complete Flow Test: SUCCESS');
                    log('   ‚úÖ Form ‚Üí Progress ‚Üí Results transitions working');
                    log('   ‚úÖ Progress updates displayed correctly');
                    log('   ‚úÖ Comprehensive stats displayed with styling');
                    
                } catch (error) {
                    log(`‚ùå Complete Flow Test Failed: ${error.message}`);
                }
            };
            
            window.testContainerTransitions = async function() {
                log('üîÑ Testing Container Transitions...');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                const containers = ['form', 'progress', 'result'];
                
                for (let i = 0; i < containers.length; i++) {
                    const container = containers[i];
                    log(`   ‚Üí Showing ${container} container`);
                    
                    if (container === 'form') {
                        fileProcessor.showForm();
                    } else if (container === 'progress') {
                        fileProcessor.showProgressContainer();
                        fileProcessor.showProgress(50, 'Testing progress display...');
                    } else if (container === 'result') {
                        const mockData = {
                            stats: { total_files: 3, processed_files: 3, error_files: 0 },
                            output_file: 'test_output.json'
                        };
                        fileProcessor.showResultContainer(mockData);
                    }
                    
                    await sleep(2000);
                }
                
                log('‚úÖ Container Transitions Test: SUCCESS');
                fileProcessor.showForm(); // Reset to form
            };
            
            window.testStatsDisplay = async function() {
                log('üìä Testing Enhanced Stats Display...');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                const mockStatsData = {
                    stats: {
                        total_files: 25,
                        processed_files: 23,
                        skipped_files: 1,
                        error_files: 1,
                        total_bytes: 2847392,
                        total_chunks: 156,
                        total_duration_seconds: 12.34,
                        avg_file_processing_time: 0.54,
                        pdf_files: 5,
                        tables_extracted: 12,
                        references_extracted: 38
                    },
                    output_file: 'comprehensive_test_output.json'
                };
                
                fileProcessor.showResultContainer(mockStatsData);
                
                log('   ‚úÖ Comprehensive stats displayed');
                log('   ‚úÖ File counts with colored icons');
                log('   ‚úÖ Performance metrics calculated');
                log('   ‚úÖ PDF-specific statistics shown');
                log('   ‚úÖ Action buttons for file operations');
                log('‚úÖ Enhanced Stats Display Test: SUCCESS');
            };
            
            // Utility functions
            window.sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            window.log = function(message) {
                const logElement = document.getElementById('test-log');
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            };
            
            window.resetTest = function() {
                log('üîÑ Resetting test environment...');
                fileProcessor.showForm();
                log('‚úÖ Test environment reset');
            };
            
            window.clearLog = function() {
                document.getElementById('test-log').innerHTML = '';
            };
            
            // Setup event listeners
            document.getElementById('test-complete-flow').addEventListener('click', testCompleteFlow);
            document.getElementById('test-container-transitions').addEventListener('click', testContainerTransitions);
            document.getElementById('test-stats-display').addEventListener('click', testStatsDisplay);
            document.getElementById('reset-test').addEventListener('click', resetTest);
            document.getElementById('clear-log').addEventListener('click', clearLog);
            
            // Initialize
            log('üöÄ Enhanced Submit ‚Üí Progress ‚Üí Stats Flow Test Initialized');
            log('   ‚úÖ FileProcessor module loaded');
            log('   ‚úÖ Mock socket connected');
            log('   ‚úÖ Test environment ready');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('üìã Instructions:');
            log('   1. Click "Test Complete Flow" to test the full Submit ‚Üí Progress ‚Üí Stats sequence');
            log('   2. Click "Test Container Transitions" to test individual container transitions');
            log('   3. Click "Test Stats Display" to test comprehensive statistics display');
            log('   4. Use "Reset Test" to return to form view');
            
        }).catch(error => {
            console.error('Failed to load FileProcessor:', error);
            document.getElementById('test-log').innerHTML = `
                <div class="text-danger">‚ùå Failed to load FileProcessor module: ${error.message}</div>
                <div>Please ensure the server is running and the module path is correct.</div>
            `;
        });
    </script>
</body>
</html>