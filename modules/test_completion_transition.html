<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completion Transition Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>File Processor Completion Transition Test</h2>
        
        <!-- Form Container -->
        <div id="form-container" class="card mb-4">
            <div class="card-body">
                <h5>File Processing Form</h5>
                <input type="text" id="input-dir" class="form-control mb-3" value="/workspace/modules/static/js/modules/config" placeholder="Input directory">
                <input type="text" id="output-file" class="form-control mb-3" value="completion_test.json" placeholder="Output file">
                <button id="submit-btn" class="btn btn-primary">Start Processing</button>
                <button id="cancel-btn" class="btn btn-danger ms-2" style="display: none;">Cancel</button>
            </div>
        </div>

        <!-- Progress Container -->
        <div id="progress-container" class="card mb-4 d-none">
            <div class="card-body">
                <h5>Processing Files...</h5>
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar" style="width: 0%">0%</div>
                </div>
                <div id="progress-status">Initializing...</div>
                <div id="progress-stats" class="small text-muted mt-2"></div>
            </div>
        </div>

        <!-- Result Container -->
        <div id="result-container" class="card mb-4 d-none">
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Processing Completed Successfully!
                </div>
                <div id="result-stats" class="mb-3"></div>
                <button id="open-btn" class="btn btn-success me-2">
                    <i class="fas fa-folder-open me-2"></i>Open Result
                </button>
                <button id="new-task-btn" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-2"></i>New Task
                </button>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="card">
            <div class="card-body">
                <h5>Debug Log</h5>
                <div id="debug-log" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                    Ready for testing...<br>
                </div>
                <button class="btn btn-outline-secondary btn-sm mt-2" onclick="clearLog()">Clear Log</button>
                <button class="btn btn-outline-info btn-sm mt-2 ms-2" onclick="testCompletion()">Test Completion</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        function logDebug(message) {
            const log = document.getElementById('debug-log');
            log.innerHTML += `${new Date().toLocaleTimeString()} - ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = 'Log cleared...<br>';
        }

        function testCompletion() {
            logDebug('üß™ Testing completion transition manually...');
            
            // Simulate the completion data
            const mockData = {
                task_id: 'test-completion-123',
                stats: {
                    total_files: 3,
                    processed_files: 3,
                    error_files: 0,
                    skipped_files: 0,
                    formatted_duration: '2.1s',
                    formatted_total_size: '48.1 KB',
                    success_rate_percent: 100
                },
                output_file: '/workspace/modules/downloads/completion_test.json'
            };

            // Test if fileProcessor exists and call showResult
            if (window.fileProcessor && window.fileProcessor.showResult) {
                logDebug('‚úÖ FileProcessor found, calling showResult...');
                try {
                    window.fileProcessor.showResult(mockData);
                    logDebug('‚úÖ showResult called successfully');
                } catch (error) {
                    logDebug(`‚ùå Error calling showResult: ${error.message}`);
                }
            } else {
                logDebug('‚ùå FileProcessor or showResult method not found');
                logDebug('üîç Available on window.fileProcessor:', Object.keys(window.fileProcessor || {}));
            }
        }

        // Initialize Socket.IO
        const socket = io('http://localhost:5025');
        
        socket.on('connect', () => {
            logDebug('üîå Socket.IO connected');
        });

        socket.on('task_completed', (data) => {
            logDebug(`‚úÖ Task completed event received: ${data.task_id}`);
            logDebug(`üìä Stats available: ${!!data.stats}`);
            
            // Check if completion transition happens
            setTimeout(() => {
                const resultContainer = document.getElementById('result-container');
                const isVisible = resultContainer && !resultContainer.classList.contains('d-none');
                logDebug(`üîç Result container visible after completion: ${isVisible}`);
            }, 1000);
        });

        // Load fileProcessor module
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                logDebug('üìÅ Loading fileProcessor module...');
                const { default: fileProcessor } = await import('./static/js/modules/features/fileProcessor.js');
                window.fileProcessor = fileProcessor;
                logDebug('‚úÖ FileProcessor module loaded');
                
                // Test if showResult method exists
                if (fileProcessor.showResult) {
                    logDebug('‚úÖ showResult method found');
                } else {
                    logDebug('‚ùå showResult method not found');
                }
            } catch (error) {
                logDebug(`‚ùå Failed to load fileProcessor: ${error.message}`);
            }
        });
    </script>
</body>
</html>