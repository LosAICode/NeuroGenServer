<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Completion Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Manual File Processor Completion Test</h2>
        <p>This test directly calls the FileProcessor completion methods to verify they work.</p>
        
        <!-- Test Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>Test Controls</h5>
                <button id="test-direct-call" class="btn btn-primary me-2">Test Direct handleTaskCompleted Call</button>
                <button id="test-force-transition" class="btn btn-warning me-2">Test Force Transition</button>
                <button id="test-emergency-transition" class="btn btn-danger">Test Emergency Transition</button>
                <div class="mt-3">
                    <h6>Expected Result:</h6>
                    <ul class="small">
                        <li>Progress container should disappear</li>
                        <li>Result container should appear with detailed stats</li>
                        <li>Console should show completion method calls</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- File Processing Structure (copy from main page) -->
        <div class="tab-content">
            <div class="tab-pane fade show active">
                <!-- Form Container -->
                <div id="form-container" class="transition-container d-none">
                    <p>Form Container (Hidden for test)</p>
                </div>

                <!-- Progress Container -->
                <div id="progress-container" class="transition-container">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-cogs me-2"></i>Processing Files
                            </h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar bg-success progress-bar-striped" 
                                     role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                    100%
                                </div>
                            </div>
                            <div id="progress-status" class="mb-2">Processing completed - transitioning to results...</div>
                            <div id="progress-stats" class="small text-muted"></div>
                            <button id="cancel-btn" class="btn btn-outline-danger" style="display: none;">
                                <i class="fas fa-times me-2"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                        
                <!-- Result Container -->
                <div id="result-container" class="transition-container d-none">
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <span>Processing Completed Successfully!</span>
                    </div>
                    <div id="result-stats" class="mb-3 small"></div>
                    <div class="d-flex gap-2 mb-3">
                        <button id="open-btn" class="btn btn-success open-json-btn">
                            <i class="fas fa-folder-open me-2"></i> Open JSON
                        </button>
                        <button id="new-task-btn" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i> New Task
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="card mt-4">
            <div class="card-body">
                <h6>Debug Console</h6>
                <div id="debug-console" style="height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px;">
                    Manual completion test ready...<br>
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearConsole()">Clear Console</button>
            </div>
        </div>
    </div>

    <script>
        // Intercept console.log to show in our debug console
        const originalLog = console.log;
        const debugConsole = document.getElementById('debug-console');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            if (debugConsole) {
                debugConsole.innerHTML += message + '<br>';
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        };

        function clearConsole() {
            debugConsole.innerHTML = 'Console cleared...<br>';
        }

        // Mock completion data
        const mockCompletionData = {
            task_id: 'test_manual_completion_123',
            task_type: 'file_processing',
            status: 'completed',
            progress: 100,
            message: 'File Processing completed successfully',
            output_file: 'C:/Users/Los/Documents/NeuroGen.Server.json',
            stats: {
                total_files: 175,
                processed_files: 175,
                error_files: 0,
                skipped_files: 0,
                formatted_duration: '2.1s',
                formatted_total_size: '48.1 KB',
                success_rate_percent: 100
            }
        };

        // Test direct call to handleTaskCompleted
        function testDirectCall() {
            console.log('🧪 Testing direct handleTaskCompleted call...');
            
            if (window.NeuroGen && window.NeuroGen.modules && window.NeuroGen.modules.fileProcessor) {
                const fileProcessor = window.NeuroGen.modules.fileProcessor;
                console.log('✅ FileProcessor found:', !!fileProcessor);
                
                if (fileProcessor.handleTaskCompleted) {
                    console.log('✅ handleTaskCompleted method found');
                    try {
                        fileProcessor.handleTaskCompleted(mockCompletionData);
                        console.log('✅ handleTaskCompleted called successfully');
                    } catch (error) {
                        console.log('❌ Error calling handleTaskCompleted:', error.message);
                    }
                } else {
                    console.log('❌ handleTaskCompleted method not found');
                }
            } else {
                console.log('❌ FileProcessor module not found');
                console.log('Available on window.NeuroGen:', Object.keys(window.NeuroGen || {}));
            }
        }

        // Test force transition
        function testForceTransition() {
            console.log('🧪 Testing forceContainerTransition...');
            
            if (window.NeuroGen && window.NeuroGen.modules && window.NeuroGen.modules.fileProcessor) {
                const fileProcessor = window.NeuroGen.modules.fileProcessor;
                
                if (fileProcessor.forceContainerTransition) {
                    console.log('✅ forceContainerTransition method found');
                    try {
                        fileProcessor.forceContainerTransition(mockCompletionData);
                        console.log('✅ forceContainerTransition called successfully');
                    } catch (error) {
                        console.log('❌ Error calling forceContainerTransition:', error.message);
                    }
                } else {
                    console.log('❌ forceContainerTransition method not found');
                }
            }
        }

        // Test emergency transition
        function testEmergencyTransition() {
            console.log('🧪 Testing emergencyContainerTransition...');
            
            if (window.NeuroGen && window.NeuroGen.modules && window.NeuroGen.modules.fileProcessor) {
                const fileProcessor = window.NeuroGen.modules.fileProcessor;
                
                if (fileProcessor.emergencyContainerTransition) {
                    console.log('✅ emergencyContainerTransition method found');
                    try {
                        fileProcessor.emergencyContainerTransition(mockCompletionData);
                        console.log('✅ emergencyContainerTransition called successfully');
                    } catch (error) {
                        console.log('❌ Error calling emergencyContainerTransition:', error.message);
                    }
                } else {
                    console.log('❌ emergencyContainerTransition method not found');
                }
            }
        }

        // Event listeners
        document.getElementById('test-direct-call').addEventListener('click', testDirectCall);
        document.getElementById('test-force-transition').addEventListener('click', testForceTransition);
        document.getElementById('test-emergency-transition').addEventListener('click', testEmergencyTransition);

        // Wait for modules to load, then auto-test
        setTimeout(() => {
            console.log('🕐 Auto-testing in 3 seconds...');
            setTimeout(() => {
                console.log('🚀 Starting auto-test sequence...');
                testDirectCall();
            }, 3000);
        }, 1000);
    </script>
</body>
</html>