<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Completion Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Emergency Completion Transition Test</h2>
        
        <!-- Progress Container (Simulating File Processor) -->
        <div id="progress-container" class="card mb-4">
            <div class="card-body">
                <h5>Processing Files...</h5>
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar bg-success" style="width: 100%">100%</div>
                </div>
                <div id="progress-status">Task completed - transitioning to results...</div>
            </div>
        </div>

        <!-- Result Container (Matching File Processor Structure) -->
        <div id="result-container" class="card mb-4 d-none">
            <div class="card-body">
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>Processing Completed Successfully!</span>
                </div>
                <div id="result-stats" class="mb-3 small"></div>
                <div class="d-flex gap-2 mb-3">
                    <button id="open-btn" class="btn btn-success open-json-btn">
                        <i class="fas fa-folder-open me-2"></i> Open JSON
                    </button>
                    <button id="new-task-btn" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i> New Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="card">
            <div class="card-body">
                <h5>Test Controls</h5>
                <button id="test-completion" class="btn btn-primary me-2">Test Emergency Completion</button>
                <button id="reset-test" class="btn btn-secondary">Reset</button>
                <div class="mt-3">
                    <h6>Expected Result:</h6>
                    <ul class="small">
                        <li>Progress container should disappear</li>
                        <li>Result container should appear with stats</li>
                        <li>Stats should show: 5 Files, 2.5s Duration, 125.8 KB Size, 100% Success</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="card mt-3">
            <div class="card-body">
                <h6>Debug Log</h6>
                <div id="debug-log" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    Ready for testing...<br>
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearDebugLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        function logDebug(message) {
            const log = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `${timestamp} - ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = 'Log cleared...<br>';
        }

        // Emergency container transition function (matching fileProcessor.js)
        function emergencyContainerTransition(data) {
            logDebug('üö® EMERGENCY: Attempting absolute simplest container transition');
            
            try {
                // Get elements using multiple fallback methods
                let progressContainer = document.getElementById('progress-container');
                let resultContainer = document.getElementById('result-container');
                
                logDebug('üö® EMERGENCY: Progress container found: ' + !!progressContainer);
                logDebug('üö® EMERGENCY: Result container found: ' + !!resultContainer);
                
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                    progressContainer.classList.add('d-none');
                    logDebug('üö® EMERGENCY: Progress container hidden');
                }
                
                if (resultContainer) {
                    resultContainer.style.display = 'block';
                    resultContainer.classList.remove('d-none');
                    logDebug('üö® EMERGENCY: Result container shown');
                    
                    // Add emergency stats if container is empty
                    if (resultContainer.innerHTML.trim().indexOf('stats') === -1) {
                        const emergencyStats = `
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 border rounded bg-light">
                                        <div class="h4 mb-1 text-primary">${data.stats?.processed_files || 'N/A'}</div>
                                        <small class="text-muted">Files</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 border rounded bg-light">
                                        <div class="h4 mb-1 text-success">${data.stats?.formatted_duration || 'N/A'}</div>
                                        <small class="text-muted">Duration</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 border rounded bg-light">
                                        <div class="h4 mb-1 text-warning">${data.stats?.formatted_total_size || 'N/A'}</div>
                                        <small class="text-muted">Size</small>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 border rounded bg-light">
                                        <div class="h4 mb-1 text-info">${data.stats?.success_rate_percent || 100}%</div>
                                        <small class="text-muted">Success</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Find the stats element and update it
                        const resultStats = document.getElementById('result-stats');
                        if (resultStats) {
                            resultStats.innerHTML = emergencyStats;
                            logDebug('üö® EMERGENCY: Stats added to result container');
                        }
                    }
                    
                    logDebug('üö® EMERGENCY: Result container transition completed');
                } else {
                    logDebug('üö® EMERGENCY: Result container not found in DOM!');
                }
                
            } catch (error) {
                logDebug('üö® EMERGENCY: Error in emergency transition: ' + error.message);
            }
        }

        function testCompletion() {
            logDebug('üß™ Starting emergency completion test...');
            
            // Mock completion data (matching fileProcessor format)
            const mockData = {
                task_id: 'test_emergency_123',
                stats: {
                    processed_files: 5,
                    formatted_duration: '2.5s', 
                    formatted_total_size: '125.8 KB',
                    success_rate_percent: 100
                },
                output_file: '/workspace/modules/downloads/test_output.json'
            };
            
            logDebug('üß™ Mock data prepared: ' + JSON.stringify(mockData.stats));
            
            // Call emergency transition
            emergencyContainerTransition(mockData);
            
            logDebug('‚úÖ Emergency completion test finished');
        }

        function resetTest() {
            const progressContainer = document.getElementById('progress-container');
            const resultContainer = document.getElementById('result-container');
            
            if (progressContainer) {
                progressContainer.classList.remove('d-none');
                progressContainer.style.display = 'block';
            }
            
            if (resultContainer) {
                resultContainer.classList.add('d-none');
                resultContainer.style.display = 'none';
                
                // Reset stats
                const resultStats = document.getElementById('result-stats');
                if (resultStats) {
                    resultStats.innerHTML = '';
                }
            }
            
            logDebug('üîÑ Test reset completed');
        }

        // Event listeners
        document.getElementById('test-completion').addEventListener('click', testCompletion);
        document.getElementById('reset-test').addEventListener('click', resetTest);
        
        // Auto-test after 3 seconds
        setTimeout(() => {
            logDebug('üïê Auto-testing emergency completion in 3 seconds...');
            setTimeout(testCompletion, 3000);
        }, 1000);
    </script>
</body>
</html>