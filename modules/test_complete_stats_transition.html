<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Processor - Complete Stats Transition Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .container-transition { transition: all 0.3s ease-in-out; }
        .test-log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            font-family: monospace; 
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry { margin-bottom: 0.25rem; }
        .log-info { color: #0d6efd; }
        .log-success { color: #198754; font-weight: bold; }
        .log-error { color: #dc3545; font-weight: bold; }
        .log-warning { color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-flask me-2"></i>File Processor - Complete Stats Transition Test</h2>
                <p class="text-muted">Test the complete Submit ‚Üí Progress ‚Üí Stats flow with enhanced completion detection</p>
            </div>
        </div>
        
        <!-- Form Container -->
        <div id="form-container" class="card mb-4 container-transition">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-play me-2"></i>Start Processing</h5>
                <form id="process-form">
                    <div class="mb-3">
                        <label for="input-dir" class="form-label">Input Directory</label>
                        <input type="text" class="form-control" id="input-dir" 
                               value="/workspace/modules/downloads/simple_test" 
                               placeholder="Enter directory path to process">
                    </div>
                    <div class="mb-3">
                        <label for="output-file" class="form-label">Output File</label>
                        <input type="text" class="form-control" id="output-file" 
                               value="complete_stats_test.json" 
                               placeholder="Output filename">
                    </div>
                    <button type="submit" id="submit-btn" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Start Processing
                    </button>
                    <button type="button" id="cancel-btn" class="btn btn-danger ms-2" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Cancel
                    </button>
                </form>
            </div>
        </div>

        <!-- Progress Container -->
        <div id="progress-container" class="card mb-4 d-none container-transition">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-spinner fa-spin me-2"></i>Processing Files...</h5>
                
                <div class="progress mb-3" style="height: 30px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
                
                <div id="progress-status" class="text-muted mb-3">
                    Initializing...
                </div>
                
                <div id="progress-stats" class="small text-muted" style="display: none;">
                    <!-- Real-time stats will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Result Container -->
        <div id="result-container" class="card mb-4 d-none container-transition">
            <div class="card-body">
                <!-- Results will be populated here by updateResultStats -->
            </div>
        </div>

        <!-- Test Log -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-terminal me-2"></i>Test Log</h5>
                <div id="test-log" class="test-log">
                    <div class="log-entry log-info">üß™ Complete Stats Transition Test initialized</div>
                    <div class="log-entry log-info">üìä Monitoring Submit ‚Üí Progress ‚Üí Stats flow...</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">
                        <i class="fas fa-trash me-2"></i>Clear Log
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="simulateCompletion()">
                        <i class="fas fa-play-circle me-2"></i>Simulate Completion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Display (for result-stats element) -->
    <div id="result-stats" class="d-none"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Initialize Socket.IO
        const socket = io('http://localhost:5025');
        window.socket = socket;

        // Test logging
        function logToTest(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = `
                <div class="log-entry log-info">üß™ Complete Stats Transition Test cleared</div>
                <div class="log-entry log-info">üìä Ready for new test...</div>
            `;
        }

        // Simulate completion for testing
        function simulateCompletion() {
            logToTest('üé¨ Simulating task completion...', 'info');
            
            // Mock task completion data
            const mockCompletionData = {
                task_id: 'test-completion-' + Date.now(),
                progress: 100,
                stats: {
                    processed_files: 25,
                    total_files: 25,
                    completion_percentage: 100.0,
                    current_stage: 'Completed',
                    formatted_duration: '3.2s',
                    formatted_total_size: '1.5 MB',
                    success_rate_percent: 100,
                    total_bytes: 1572864,
                    total_chunks: 128,
                    pdf_files: 5,
                    error_files: 0,
                    skipped_files: 0
                },
                output_file: '/workspace/modules/downloads/complete_stats_test.json',
                message: 'Processing completed successfully!'
            };
            
            // Simulate the fileProcessor receiving this data
            if (window.fileProcessor) {
                logToTest('üì° Sending completion data to fileProcessor...', 'info');
                window.fileProcessor.handleTaskCompleted(mockCompletionData);
                logToTest('‚úÖ Mock completion sent - check if results display properly', 'success');
            } else {
                logToTest('‚ùå fileProcessor not available for simulation', 'error');
            }
        }

        // Socket event monitoring
        socket.on('connect', () => {
            logToTest('üîå Socket.IO connected to backend', 'success');
        });

        socket.on('disconnect', () => {
            logToTest('üîå Socket.IO disconnected', 'warning');
        });

        socket.on('task_started', (data) => {
            logToTest(`üöÄ Task started: ${data.task_id}`, 'info');
        });

        socket.on('progress_update', (data) => {
            logToTest(`üìä Progress: ${data.progress}% - ${data.message}`, 'info');
            if (data.progress >= 100) {
                logToTest('üéØ 100% completion detected in progress update!', 'success');
            }
        });

        socket.on('task_completed', (data) => {
            logToTest(`‚úÖ Task completed: ${data.task_id}`, 'success');
            logToTest('üéâ Checking if UI transitions to stats screen...', 'info');
            
            // Check if result container becomes visible
            setTimeout(() => {
                const resultContainer = document.getElementById('result-container');
                const isVisible = resultContainer && !resultContainer.classList.contains('d-none');
                if (isVisible) {
                    logToTest('‚úÖ SUCCESS: Results container is now visible!', 'success');
                } else {
                    logToTest('‚ùå ISSUE: Results container is still hidden', 'error');
                }
            }, 1000);
        });

        socket.on('task_error', (data) => {
            logToTest(`‚ùå Task error: ${data.error}`, 'error');
        });

        // Initialize File Processor when available
        document.addEventListener('DOMContentLoaded', async () => {
            logToTest('üèÉ DOM ready, initializing File Processor...', 'info');
            
            try {
                // Wait for the fileProcessor module to load
                let attempts = 0;
                const maxAttempts = 10;
                
                const waitForFileProcessor = async () => {
                    if (window.fileProcessor) {
                        logToTest('‚úÖ File Processor loaded successfully', 'success');
                        
                        // Monitor state changes
                        const originalShowResult = window.fileProcessor.showResult;
                        window.fileProcessor.showResult = function(data) {
                            logToTest('üéØ showResult called!', 'success');
                            logToTest(`üìä Stats data: ${JSON.stringify(data.stats?.processed_files || 'N/A')} files`, 'info');
                            return originalShowResult.call(this, data);
                        };
                        
                        const originalTransitionToContainer = window.fileProcessor.transitionToContainer;
                        window.fileProcessor.transitionToContainer = function(targetContainer) {
                            if (targetContainer && targetContainer.id === 'result-container') {
                                logToTest('üì¶ Transitioning to result container!', 'success');
                            }
                            return originalTransitionToContainer.call(this, targetContainer);
                        };
                        
                        return;
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(waitForFileProcessor, 500);
                    } else {
                        logToTest('‚ùå File Processor failed to load after 5 seconds', 'error');
                    }
                };
                
                await waitForFileProcessor();
                
            } catch (error) {
                logToTest(`‚ùå Error initializing: ${error.message}`, 'error');
            }
        });
        
        logToTest('üéØ Complete Stats Transition Test ready', 'success');
    </script>
    
    <!-- Load File Processor Module -->
    <script type="module">
        try {
            const { default: fileProcessor } = await import('./static/js/modules/features/fileProcessor.js');
            window.fileProcessor = fileProcessor;
            console.log('üìÅ File Processor module loaded for testing');
        } catch (error) {
            console.error('‚ùå Failed to load File Processor module:', error);
            document.getElementById('test-log').innerHTML += `
                <div class="log-entry log-error">‚ùå Failed to load File Processor: ${error.message}</div>
            `;
        }
    </script>
</body>
</html>